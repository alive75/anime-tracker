// packages/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  // The 'native' target is for your local machine.
  // The 'linux-musl-openssl-3.0.x' is specifically for the Alpine Linux
  // environment inside Docker, matching its OpenSSL version. This fixes the error.
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Models

model User {
  id            Int         @id @default(autoincrement())
  email         String      @unique
  password_hash String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  animeList     UserAnime[]
}

model Anime {
  id              Int         @id // Jikan/MAL ID, not auto-incremented
  title           String
  synopsis        String      @db.Text
  totalEpisodes   Int
  airingStatus    String
  coverImageUrl   String      @db.Text
  releaseYear     Int
  genres          String[]    // PostgreSQL array type
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  userEntries     UserAnime[]
}

model UserAnime {
  id              Int             @id @default(autoincrement())
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int
  anime           Anime           @relation(fields: [animeId], references: [id], onDelete: Cascade)
  animeId         Int
  userStatus      UserAnimeStatus
  watchedEpisodes Int
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([userId, animeId]) // A user can only have one entry per anime
  @@index([userId])
  @@index([animeId])
}

// Enums

enum UserAnimeStatus {
  WATCHING
  COMPLETED
  PLANNED
  DROPPED
  PAUSED
}
