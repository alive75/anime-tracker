# EstÃ¡gio 1: Builder - ConstrÃ³i a aplicaÃ§Ã£o
FROM node:20-alpine AS builder

# Instala o OpenSSL, que Ã© uma dependÃªncia do Prisma Client para o Alpine.
RUN apk add --no-cache openssl

WORKDIR /app

# Copia os manifestos de pacotes e o lock file para aproveitar o cache do Docker.
COPY package.json package-lock.json* ./
COPY packages/api/package.json ./packages/api/

# Instala todas as dependÃªncias (incluindo devDependencies para o build)
RUN npm install

# Copia todo o cÃ³digo-fonte da API
COPY packages/api/ ./packages/api/

# Gera o cliente Prisma ANTES do build
WORKDIR /app/packages/api
RUN npx prisma generate

# ConstrÃ³i a aplicaÃ§Ã£o da API
WORKDIR /app
RUN npm run build:api

# ---
# EstÃ¡gio 2: Production - Cria a imagem final
FROM node:20-alpine

# Instala o OpenSSL para o Prisma Client
RUN apk add --no-cache openssl

WORKDIR /app

# Copia os package.json files
COPY --from=builder /app/package.json ./
COPY --from=builder /app/packages/api/package.json ./packages/api/

# Copia o cÃ³digo fonte da API (necessÃ¡rio para o Prisma)
COPY --from=builder /app/packages/api/prisma ./packages/api/prisma

# Instala APENAS as dependÃªncias de produÃ§Ã£o
RUN npm install --production --workspace=api

# Gera o Prisma Client novamente no ambiente de produÃ§Ã£o
WORKDIR /app/packages/api
RUN npx prisma generate

# Volta para o diretÃ³rio raiz
WORKDIR /app

# Copia a aplicaÃ§Ã£o construÃ­da
COPY --from=builder /app/packages/api/dist ./packages/api/dist

# ExpÃµe a porta
EXPOSE 3001

# Script de inicializaÃ§Ã£o que garante que tudo estÃ¡ funcionando
RUN echo '#!/bin/sh' > /start.sh && \
    echo 'set -e' >> /start.sh && \
    echo 'echo "ðŸ”„ Starting Anime Tracker API..."' >> /start.sh && \
    echo 'cd /app/packages/api' >> /start.sh && \
    echo 'echo "ðŸ“Š Running database migrations..."' >> /start.sh && \
    echo 'npx prisma migrate deploy || (echo "âŒ Migration failed" && exit 1)' >> /start.sh && \
    echo 'echo "âœ… Migrations completed successfully"' >> /start.sh && \
    echo 'cd /app' >> /start.sh && \
    echo 'echo "ðŸš€ Starting NestJS application..."' >> /start.sh && \
    echo 'node packages/api/dist/main' >> /start.sh && \
    chmod +x /start.sh

CMD ["/start.sh"]
